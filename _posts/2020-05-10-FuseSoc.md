---
layout: post
title: A Gentle Introduction into FuseSoC through CoreScore
date:  2020-05-10 00:00:00 -1000
categories:
---

* TOC
{:toc}

# Introduction

Most major companies have highly tuned design flows with tools to make IP integration easier. They
also have elaborate build system to run simulations, perform code quality checks, kick of synthesis
runs etc.

When you come home from your day job to start the hobby electronics part of your life, your
requirements are usually quite a bit lower, but you can't stop but thinking about how nice it would
be to at least have some of that power at home as well.

For most of my hobby code, I've switched from Verilog to [SpinalHDL](https://spinalhdl.github.io/SpinalDoc-RTD/SpinalHDL/Getting%20Started/index.html) 
as main RTL language. When used to its fullest, it allows assembly of complex design hierarchies with a minimal of
redundant code. It supports simulations and synthesis. In general, it covers most of the needs of
a designer, especially when everything is done within a SpinalHDL environment.

But the learning curve of SpinalHDL is steep and integrating external IP blocks is a clunky. Sometimes,
you want a tool that can work with regular Verilog IP blocks.

FuseSoC is an open source tool that tries to fill that role.

According to the [documentation](https://fusesoc.readthedocs.io/en/rtd/fusesoc.html):

> FuseSoC is a package manger and a set of build tools for HDL code.
>
> Its main purpose is to increase reuse of IP cores and be an aid for creating, building and 
> simulating SoC solutions.

This blog post tries to get a first feel of FuseSoC by porting 2 FuseSoC example designs to
my Cisco HWIC-3G-CDMA development board.

The 2 designs are the [FuseSoC blinky](https://github.com/fusesoc/blinky) and [CoreScore](https://github.com/olofk/corescore),
design that tries to cram as many bit-serial RISC-V CPUs into your FPGA as possible.

# Installing FuseSoC

Since FuseSoC is written in Python, and since I don't expect to be expanding or changing FuseSoC myself anytime soon,
I installed it the straightforward way:

```
sudo pip install fusesoc
```

However, if you want to run a locally clone version of [the bleeding edge repo](https://github.com/olofk/fusesoc/), 
you can [easily do that as well](https://github.com/olofk/fusesoc/blob/master/README.rst#quick-start).


# FuseSoc Cores

FuseSoc is all about dealing cores: a packaged bundle of RTL files, timing files, etc. for a particular self-contained
design. At the top is a `.core` file which links everything together.

FuseSoc already has a large library of packaged design. After first installing FuseSoC, the list isn't known yet. To do
that, you have to run the following initialization step once:

```
fusesoc init
```

This created the `~/.config/fusesoc/fusesoc.conf` file on my system:
```
[library.orpsoc-cores]
location = /home/tom/.local/share/fusesoc/orpsoc-cores
sync-uri = https://github.com/openrisc/orpsoc-cores
sync-type = git
auto-sync = true

[library.fusesoc-cores]
location = /home/tom/.local/share/fusesoc/fusesoc-cores
sync-uri = https://github.com/fusesoc/fusesoc-cores
sync-type = git
auto-sync = true
```

Everything is in place now to list all the available cores:

```
> fusesoc list-cores

Available cores:

Core                                     Cache status
================================================================================
::SD-card-controller:0                 : empty
::SD-card-controller:0-r1              : empty
::SD-card-controller:0-r2              : empty
::SD-card-controller:0-r3              : empty
::ac97:0                               : empty
...
fusesoc:utils:blinky:0                 : empty                  <<<<< !!!
...
```

These cores aren't installed locally on your machine just yet! When you want to use one, you need
to explicitly add them to your local library. We'll get to that later.

# FuseSoc Blinky - LED to Believe

To get a first hands-on experience about working with FuseSoC, I decided to try out the all-important
blinky. 

The goal of the "[LED to believe](https://github.com/fusesoc/blinky#led-to-believe)" project is to make 
FuseSoC blinky run on as many FPGA development boards as possible. After spending hours to covert the 
[Cisco HWIC-3G-CDMA](/2019/11/11/Cisco-HWIC-3G-CDMA.html) into a development platform, the time was right 
to add this board to the list!

Blink is part of the standard FuseSoc library, so if I wanted to use it as-is, I could just link to it without
needing a local copy. However, I wanted to make modifications to make it work for my board, so I cloned
the repo to my local drive.

# Running Existing Blinky Targets

One of my issues with FuseSoC is that some instructions are written for the point-of-view of somebody 
who already knows what to do and how to do it. Especially for a tutorial, I prefer step-by-step
instructions that don't leave any doubt.

Here's how I made things works:

```sh
cd ~/projects
git clone https://github.com/tomverbeure/blinky fusesoc-blinky
mkdir blinky_workspace
cd blinky_workspace
fusesoc library add blinky ~/projects/fusesoc-blinky
```

The `blinky_workspace` directory is root location where all temporal directories, generated files, simulations
results, bitstreams, etc. will be stored. The location of the `workspace` directory can be anywhere.

When we now look inside our workspace directory, we see the `fusesoc.conf` file:
```
[library.blinky]
location = /home/tom/projects/fusesoc-blinky
sync-uri = ../fusesoc-blinky/
sync-type = local
auto-sync = true
```

We've added the FuseSoC blinky to our library under the name "blinky".

There are 2 links to fusesoc-blink: a `sync-uri` and a `location`. What struck me 
was that the location points to `/home/tom/projects/fusesoc-blinky-tvb`, an absolute file path.
I heavily dislike absolute paths, since they tie you down to irrelevant specifics of your
local system. Since I assume that the `fusesoc.conf` file is something that eventually might be checked
into some kind of revision control system, and shared with other colaborators, I wondered
what would happen if I renamed that location to some non-existing directory:

```
WARNING: Failed to register library '/home/tom/projects/fusesoc-blinky-dummy is not a directory'
Name          : Location                                     : Sync type : Sync URI                                 : Auto sync
orpsoc-cores  : /home/tom/.local/share/fusesoc/orpsoc-cores  : git       : https://github.com/openrisc/orpsoc-cores : y        
fusesoc-cores : /home/tom/.local/share/fusesoc/fusesoc-cores : git       : https://github.com/fusesoc/fusesoc-cores : y        
```

Cleary, it doesn't like it, but it also doesn't crash. But later commands would error out...

Anyway, after restoring the path, it was able to run a blinking simulation:

```
tom@thinkcenter:~/projects/blinky_workspace$ fusesoc run --target=sim fusesoc:utils:blinky

INFO: Preparing ::vlog_tb_utils:1.1
INFO: Preparing fusesoc:utils:blinky:0
INFO: Setting up project

INFO: Building
iverilog -sblinky_tb -c fusesoc_utils_blinky_0.scr -o fusesoc_utils_blinky_0 
warning: Found both default and `timescale based delays. Use
       : -Wtimescale to find the module(s) with no `timescale.
INFO: Running
vvp -n -M. -l icarus.log  fusesoc_utils_blinky_0 -fst 
Pulse 1/5 OK!
Pulse 2/5 OK!
Pulse 3/5 OK!
Pulse 4/5 OK!
Pulse 5/5 OK!
Testbench finished OK
```

I was also able to create a bitstream for my Upduino2 board:
```
fusesoc run --target=upduino2  fusesoc:utils:blinky

INFO: Preparing fusesoc:utils:blinky:0
INFO: Setting up project
INFO: Setting up project

INFO: Building
make -f fusesoc_utils_blinky_0.mk
make[1]: Entering directory '/home/tom/projects/blinky_workspace/build/fusesoc_utils_blinky_0/upduino2-icestorm'
yosys -l yosys.log -p "tcl fusesoc_utils_blinky_0.tcl"
...
icepack fusesoc_utils_blinky_0_next.asc fusesoc_utils_blinky_0.bin
INFO: Running
INFO: Running post_run script iceprog

Build was completed

To program the board run:
iceprog /home/tom/projects/blinky_workspace/build/fusesoc_utils_blinky_0/upduino2-icestorm/fusesoc_utils_blinky_0.bin
```

# FuseSoC Blinky - Adding a New Target

The LED to Believe project encourages users to add support for new boards, but doesn't tell you how.

It's not at all complicated once you figure it out, but it still took me a while, just grepping through
a bunch of directories and files until the few pieces of the puzzle fell into place.

I thought that there'd be a difference between a core (an IP block) and a target (a particular FPGA board). That
turns out to not be the case: everything is a core and that is that.

You can list all the cores that are already supported by blinky as follows:

```
fusesoc core-info fusesoc:utils:blinky

CORE INFO
Name:      fusesoc:utils:blinky:0
Core root: /home/tom/projects/fusesoc-blinky-tvb

Targets:
AnalogMax                      : <No description>
alhambra_II                    : Alhambra II iCE40-HX4K based open-source hardware board
apf27                          : <No description>
arty_a7_35t                    : <No description>
...
```

To add your own the FPGA dev board, you need to do the following:
* Create a number of design files that are specific to your particular core
* Add your board to list of supported cores
* Add a list with these files to a `fileset` that is specific to your core

The key file here is the `[blinky.core](https://github.com/fusesoc/blinky/blob/master/blinky.core)` file 
in the the fusesoc-blinky repo.



* Clone https://github.com/fusesoc/blinky to your own repo https://github.com/tomverbeure/blinky 
* git clone https://github.com/tomverbeure/blinky fusesoc-blinky-tvb
* cd fusesoc-blinky-tvb
* mkdir workspace
* cd workspace
* fusesoc library add blinky ..

Simulate:
* fusesoc run --target=sim fusesoc:utils:blinky

List all supported cores:
* fusesoc core-info fusesoc:utils:blinky

* cd ../
* Copy cyc1000 dir to cisco-hwic-3g-cdma
* edit blinky.core and add cisco-hwic-3g-cdma. There are 2 places in this file where you need to add it!
* export QUARTUS_ROOTDIR="/home/tom/altera/13.0sp1/quartus" 
* PATH="$QUARTUS_ROOTDIR/bin:$PATH"
* fusesoc run --target=cisco-hwic-3g-cdma fusesoc:utils:blinky


# Install Clone FuseSoc

* Clone .../fusesoc to your own repo https://github.com/tomverbeure/fusesoc

```
git clone https://github.com/tomverbeure/fusesoc.git fusesoc-tvb
cd fusesoc-tvb/
pip install -e
```


# CoreScore

https://github.com/olofk/corescore -> https://github.com/tomverbeure/corescore

```
git clone https://github.com/tomverbeure/corescore.git corescore-tvb
cd corescore-tvb
mkdir workspace
cd workspace
fusesoc library add fusesoc-cores https://github.com/fusesoc/fusesoc-cores
fusesoc library add corescore ..

# List all supported targes
fusesoc core-info corescore

# Run 
fusesoc run --target=upduino2 corescore
```

Files to change:

* corescore.core

    Lists all the different targets and the custom RTL and constraint files that are needed for that target.

    There are 3 entries per target: the fileset, the target information, and the generate list
        
    * Add the new files for your target to filesets
    * Add your new target to the targets
    * Add your new target to the generate list

    In my case, since the Cisco HWIC-3G-CDMA board uses an Intel FPGA, I used the Cyc1000 target (which uses an Intel Cyclone 10 LP) as
    a template and made modifications.

* non-RTL design files

    The ./data directory contains the non-RTL design files: timing, pin mapping etc.
    
* RTL
